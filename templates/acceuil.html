{% extends "layout.html" %}
{% block body %}
<body>
    <div id="acceuil">
        <!-- Navigation -->
        <nav>
            <a href="#features">Features</a>
            <a href="#about">About Us</a>
            <a href="#contact">Contact</a>
        </nav>

        <!-- Hero Section -->
        <div id="hero">
            <h1>Explore Endless Possibilities</h1>
            <p>Join our platform to access exclusive content and connect with a vibrant community.</p>
            <button onclick="location.href='/start_game'" id="start">Start Game</button>
            <button id="join">Join Game</button>
        </div>

        <!-- Features Section -->
        <section id="features" class="features">
            <div class="feature">
                <img src="https://via.placeholder.com/100" alt="Feature 1">
                <h3>Easy to Use</h3>
                <p>Our platform is designed with simplicity in mind, making it accessible for everyone.</p>
            </div>
            <div class="feature">
                <img src="https://via.placeholder.com/100" alt="Feature 2">
                <h3>Secure</h3>
                <p>Your data and privacy are our top priorities. We ensure the highest level of security.</p>
            </div>
            <div class="feature">
                <img src="https://via.placeholder.com/100" alt="Feature 3">
                <h3>24/7 Support</h3>
                <p>Our dedicated team is always available to assist you with any queries or issues.</p>
            </div>
        </section>
        <a href="/logout">Log out</a>
    </div>

    <div id="launcher" hidden>
        <div id="ball" >
            <button id="closeButton1">Close</button>
            <h1>Game Code</h1> 
        </div>
       <button id="startGameButton" onclick="launchGame()" disabled>Lancer la Partie</button>
    </div>
    <div id="door" hidden >
        <button id="closeButton2">Close</button>
        <h1>Enter Code</h1>
        <form id="code-form">
            <div class="code-container">
                <!-- 6 cases pour chaque chiffre -->
                <input type="text" maxlength="1" pattern="\d" required>
                <input type="text" maxlength="1" pattern="\d" required>
                <input type="text" maxlength="1" pattern="\d" required>
                <input type="text" maxlength="1" pattern="\d" required>
                <input type="text" maxlength="1" pattern="\d" required>
                <input type="text" maxlength="1" pattern="\d" required>
            </div>
            <button type="submit" id="validate">Valider</button>
        </form>
    </div>

</body>
<script>
    document.getElementById('start').onclick = async function (e) {
        e.preventDefault();

        // Get the element to display the result
        const codebox = document.getElementById('ball');
        const launcher = document.getElementById('launcher');
        launcher.removeAttribute('hidden');
        const principal = document.getElementById('acceuil');
        principal.style.filter = 'blur(5px)';;

        try {
            // Send the POST request to the server
            const response = await fetch('/start_game', {
                method: 'POST'
            });

            // Check if the response is OK
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            // Parse the JSON response
            const code = await response.json();

            // Create a new paragraph element to display the result

            const bigBox = document.createElement('div');
            bigBox.id = "code";
            code.forEach((num) => {
                // Create a new div element for each number
                const boxElement = document.createElement('div');
                boxElement.textContent = num; // Set the number as the content
                boxElement.style.color = 'darkgreen';
                boxElement.style.backgroundColor = 'white';
                boxElement.style.border = '1px solid darkgreen';
                boxElement.style.padding = '10px';
                boxElement.style.margin = '5px';
                boxElement.style.display = 'inline-block'; // Display elements side-by-side
                boxElement.style.borderRadius = '5px';
                boxElement.style.fontSize = '16px';
                bigBox.append(boxElement);
        });

        // Append the box to the codebox container
        codebox.appendChild(bigBox);

        } catch (error) {
            console.error('Error:', error);

            // Create and append an error message
            const errorMessage = document.createElement('p');
            errorMessage.style.color = "red";
            errorMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
            codebox.appendChild(errorMessage);
        }
    };

    // Close button logic
    document.getElementById('closeButton1').onclick = function () {
            const codebox = document.getElementById('ball');
            const launcher = document.getElementById('launcher');
            const principal = document.getElementById('acceuil');
            const code = document.getElementById('code')
            // Reset the codebox to its initial state
            launcher.setAttribute('hidden', 'true'); 
            // Hide the codebox by removing it from the DOM
            code.remove();
            principal.style.filter = 'blur(0px)';


        };
        
    document.getElementById('join').onclick = async function (e) {
        e.preventDefault();

        // Get the element to display the result
        const codebox = document.getElementById('door');
        codebox.removeAttribute('hidden');
        const principal = document.getElementById('acceuil');
        principal.style.filter = 'blur(5px)';;
    };
    const inputs = document.querySelectorAll(".code-container input");

        // Permet de passer automatiquement au champ suivant
        inputs.forEach((input, index) => {
            input.addEventListener("input", (event) => {
                const value = event.target.value;
                if (value.length === 1 && index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            });

            // Permet de revenir au champ précédent si on efface
            input.addEventListener("keydown", (event) => {
                if (event.key === "Backspace" && index > 0 && !input.value) {
                    inputs[index - 1].focus();
                }
            });
        });

        // Gestion du formulaire
        document.getElementById('validate').onclick = async function (e) {
            event.preventDefault();

            // Récupérer les valeurs des cases
            const code = Array.from(inputs).map(input => input.value).join("");

            if (code.length === 6) {
                console.log("Code soumis :", code);
                // Envoyer au backend (Exemple avec fetch)

                        // Appel AJAX pour rejoindre une partie
                        fetch('/join_game', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ game_code: code })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.redirect) {
                                // Rediriger vers l'URL reçue
                                window.location.href = data.redirect;
                            } else if (data.error) {
                                // Gérer l'erreur (ex: code de partie invalide)
                                alert(data.error);
                            }
                        })
                        .catch(error => console.error('Erreur:', error));
                    }

                
            };

        document.getElementById('closeButton2').onclick = function () {
            const codebox = document.getElementById('door');
            const principal = document.getElementById('acceuil');
            // Reset the codebox to its initial state
            codebox.setAttribute('hidden', 'true'); 
            principal.style.filter = 'blur(0px)';


        };
        function launchGame() {
            fetch('/launch_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    console.log(data.message);
                    // Rediriger les deux joueurs vers la page de la partie
                    checkGameStatus();
                }
            })
            .catch(error => console.error('Erreur:', error));
        }
        function checkGameStatus() {
                fetch('/game_state', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.state === 'started') {
                        // Rediriger vers la page de la partie si le jeu a commencé
                        window.location.href = `/game/${data.game_code}`;
                    }
                })
                .catch(error => console.error('Erreur:', error));
            }

            // Appeler la fonction checkGameStatus toutes les 3 secondes
            setInterval(checkGameStatus, 3000);

</script>

{% endblock %}